---
import themes from "../styles/themes.json";
---

<script define:vars={{ themes }}>
  function findThemeDefinition(item) {
    return themes.find((t) => t.name === item);
  }

  const item = window.localStorage.getItem("theme");
  const themeDefinition = findThemeDefinition(item);

  if (item && !themeDefinition) {
    window.localStorage.setItem("theme", "d");
    console.log("issue: style: theme not found, set to default");
  }

  const themeValue = themeDefinition || findThemeDefinition("default");
  let theme = window.matchMedia("(prefers-color-scheme: dark)").matches
    ? themeValue.dark
    : themeValue.light;

  window
    .matchMedia("(prefers-color-scheme: dark)")
    .addEventListener("change", (e) => {
      const newTheme = findThemeDefinition(
        window.localStorage.getItem("theme")
      );

      theme = e.matches ? newTheme.dark : newTheme.light;
      switchTheme(theme, newTheme);

      console.log("style: polarity switched to:", e.matches ? "dark" : "light");
    });

  function switchTheme(theme, themeBase) {
    document.documentElement.style.setProperty(
      "--primary-color",
      theme.primary
    );
    document.documentElement.style.setProperty(
      "--secondary-color",
      theme.secondary
    );
    document.documentElement.style.setProperty(
      "--background-color",
      theme.background
    );
    document.documentElement.style.setProperty(
      "--tertiary-color",
      theme.tertiary
    );

    document
      .querySelector("meta[name=theme-color]")
      .setAttribute("content", theme.background);

    document.querySelectorAll(".theme").forEach((link) => {
      if (link.id !== themeBase.name) {
        link.classList.remove("active");
        link.textContent = `○ ${link.id}`;
      } else {
        link.classList.add("active");
        link.textContent = `● ${link.id}`;
      }
    });
  }

  switchTheme(theme, themeValue);
</script>
